---
title: "DataFest 2020 - How Will COVID-19 Affect the Occupancy in Temporary Shelters?"
author: Minsung Kim and Jonas Lee
date: June 15, 2020
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r message = FALSE, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(lmtest)
#reading the csv
shelterData <- read.csv("https://raw.githubusercontent.com/alexminsung/ISSC/master/data/Daily%20shelter%20occpancy%20current.csv?token=APUVSRCQBS7QDHDGTMGCLMS65JGQU")
attach(shelterData)

# list of shelters to use later
target <- c("Cornerstone Place", "Fred Victor Centre", "St. Simon's Shelter Inc.",
            "The Scott Mission Inc.")

# filters the data for use of comparing the relationship between COVID-19 cases and occupancy numbers in shelters
shelterByCovid <- shelterData %>%
  filter(as.character(ORGANIZATION_NAME) %in% target)

```

Qs: The effects of covid19 on the occupancy count(percent) of temporary shelters around GTA

```{r echo = FALSE}

# filters the data to include only Men and Women observations. Such measurements were taken because they made up most of the 
# observations and also to better illustrate a trend.
shelterData %>%
  filter(as.character(SECTOR) == "Women" & as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00") %>%
  mutate(relaFreq = OCCUPANCY/CAPACITY) %>%
  ggplot(aes(x = OCCUPANCY_DATE, y = relaFreq, color = SHELTER_NAME)) + geom_point() + facet_wrap(SHELTER_CITY~ORGANIZATION_NAME) + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + 
  labs(title = "Shelters Occupancy to Capacity Percent by Organizations (Women)", x = "Occupancy Date", y = "Relative Frequency", 
       colour = "Shelter Names")
  
shelterData %>%
  filter(as.character(SECTOR) == "Men" & as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00") %>%
  mutate(relaFreq = OCCUPANCY/CAPACITY) %>%
  ggplot(aes(x = OCCUPANCY_DATE, y = relaFreq, color = SHELTER_NAME)) + geom_point() + facet_wrap(SHELTER_CITY~ORGANIZATION_NAME) + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + 
  labs(title = "Shelters Occupancy to Capacity Percent by Organizations (Women)", x = "Occupancy Date", y = "Relative Frequency", colour = "Shelter Names")


  
```

```{r echo = FALSE}

#Men for a month by month basis:
# men_january <- c("2020-01-01T00:00:00", "2020-01-02T00:00:00", "2020-01-03T00:00:00", "2020-01-04T00:00:00", "2020-01-05T00:00:00", "2020-01-06T00:00:00", "2020-01-07T00:00:00", "2020-01-08T00:00:00", "2020-01-09T00:00:00", "2020-01-10T00:00:00", "2020-01-11T00:00:00", "2020-01-12T00:00:00", "2020-01-13T00:00:00", "2020-01-14T00:00:00", "2020-01-15T00:00:00", "2020-01-16T00:00:00", "2020-01-17T00:00:00", "2020-01-18T00:00:00", "2020-01-19T00:00:00", "2020-01-20T00:00:00", "2020-01-21T00:00:00", "2020-01-22T00:00:00", "2020-01-23T00:00:00", "2020-01-24T00:00:00", "2020-01-25T00:00:00", "2020-01-26T00:00:00", "2020-01-27T00:00:00", "2020-01-28T00:00:00", "2020-01-29T00:00:00", "2020-01-30T00:00:00", "2020-01-31T00:00:00")
# men_february <- c("2020-02-01T00:00:00", "2020-02-02T00:00:00", "2020-02-03T00:00:00", "2020-02-04T00:00:00", "2020-02-05T00:00:00", "2020-02-06T00:00:00", "2020-02-07T00:00:00", "2020-02-08T00:00:00", "2020-02-09T00:00:00", "2020-02-10T00:00:00", "2020-02-11T00:00:00", "2020-02-12T00:00:00", "2020-02-13T00:00:00", "2020-02-14T00:00:00", "2020-02-15T00:00:00", "2020-02-16T00:00:00", "2020-02-17T00:00:00", "2020-02-18T00:00:00", "2020-02-19T00:00:00", "2020-02-20T00:00:00", "2020-02-21T00:00:00", "2020-02-22T00:00:00", "2020-02-23T00:00:00", "2020-02-24T00:00:00", "2020-02-25T00:00:00", "2020-02-26T00:00:00", "2020-02-27T00:00:00", "2020-02-28T00:00:00", "2020-02-29T00:00:00")
# men_march <- c("2020-03-01T00:00:00", "2020-03-02T00:00:00", "2020-03-03T00:00:00", "2020-03-04T00:00:00", "2020-03-05T00:00:00", "2020-03-06T00:00:00", "2020-03-07T00:00:00", "2020-03-08T00:00:00", "2020-03-09T00:00:00", "2020-03-10T00:00:00", "2020-03-11T00:00:00", "2020-03-12T00:00:00", "2020-03-13T00:00:00", "2020-03-14T00:00:00", "2020-03-15T00:00:00", "2020-03-16T00:00:00", "2020-03-17T00:00:00", "2020-03-18T00:00:00", "2020-03-19T00:00:00", "2020-03-20T00:00:00", "2020-03-21T00:00:00", "2020-03-22T00:00:00", "2020-03-23T00:00:00", "2020-03-24T00:00:00", "2020-03-25T00:00:00", "2020-03-26T00:00:00", "2020-03-27T00:00:00", "2020-03-28T00:00:00", "2020-03-29T00:00:00", "2020-03-30T00:00:00", "2020-03-31T00:00:00")
# men_april <- c("2020-04-01T00:00:00", "2020-04-02T00:00:00", "2020-04-03T00:00:00", "2020-04-04T00:00:00", "2020-04-05T00:00:00", "2020-04-06T00:00:00", "2020-04-07T00:00:00", "2020-04-08T00:00:00", "2020-04-09T00:00:00", "2020-04-10T00:00:00", "2020-04-11T00:00:00", "2020-04-12T00:00:00", "2020-04-13T00:00:00", "2020-04-14T00:00:00", "2020-04-15T00:00:00", "2020-04-16T00:00:00", "2020-04-17T00:00:00", "2020-04-18T00:00:00", "2020-04-19T00:00:00", "2020-04-20T00:00:00", "2020-04-21T00:00:00", "2020-04-22T00:00:00", "2020-04-23T00:00:00", "2020-04-24T00:00:00", "2020-04-25T00:00:00", "2020-04-26T00:00:00", "2020-04-27T00:00:00", "2020-04-28T00:00:00", "2020-04-29T00:00:00", "2020-04-30T00:00:00")
# men_may <- c("2020-05-01T00:00:00", "2020-05-02T00:00:00", "2020-05-03T00:00:00", "2020-05-04T00:00:00", "2020-05-05T00:00:00", "2020-05-06T00:00:00", "2020-05-07T00:00:00", "2020-05-08T00:00:00", "2020-05-09T00:00:00", "2020-05-10T00:00:00", "2020-05-11T00:00:00", "2020-05-12T00:00:00", "2020-05-13T00:00:00", "2020-05-14T00:00:00", "2020-05-15T00:00:00", "2020-05-16T00:00:00", "2020-05-17T00:00:00", "2020-05-18T00:00:00", "2020-05-19T00:00:00", "2020-05-20T00:00:00", "2020-05-21T00:00:00", "2020-05-22T00:00:00", "2020-05-23T00:00:00", "2020-05-24T00:00:00", "2020-05-25T00:00:00", "2020-05-26T00:00:00", "2020-05-27T00:00:00", "2020-05-28T00:00:00", "2020-05-29T00:00:00", "2020-05-30T00:00:00", "2020-05-31T00:00:00")
# men_june <- c("2020-06-01T00:00:00", "2020-06-02T00:00:00", "2020-06-03T00:00:00", "2020-06-04T00:00:00", "2020-06-05T00:00:00", "2020-06-06T00:00:00", "2020-06-07T00:00:00", "2020-06-08T00:00:00")
# # Filters the data by Occupancy Date
# monthM <- c(men_january, men_february, men_march, men_april, men_may, men_june)
# 
# 
# shelterData %>%
#   filter(as.character(SECTOR) == "Men" & as.character(OCCUPANCY_DATE) %in% men_april) %>%
#   mutate(relaFreq = OCCUPANCY/CAPACITY) %>%
#   ggplot(aes(x = OCCUPANCY_DATE, y = relaFreq, color = SHELTER_NAME)) + facet_wrap(SHELTER_CITY~ORGANIZATION_NAME) + geom_point() + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) +  geom_vline(xintercept = importantDates, color= "black", linetype="dashed") + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) 
```

```{r echo = FALSE}

# recorded dates for COVID-19 cases exceeding 20 in shelters 
importantDates <- c('2020-04-09T00:00:00', '2020-04-16T00:00:00', '2020-05-20T00:00:00', '2020-04-09T00:00:00',
                    '2020-05-14T00:00:00', '2020-05-16T00:00:00', '2020-05-22T00:00:00')

# creates a graph to showcase the correlation in some of the shelters
shelterByCovid %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-017T00:00:00") %>%
  mutate(relaFreq = OCCUPANCY/CAPACITY) %>%
  ggplot(aes(x = OCCUPANCY_DATE, y = OCCUPANCY, color = SHELTER_NAME)) + geom_point() + 
  facet_wrap(~ORGANIZATION_NAME) +
  geom_vline(xintercept = importantDates, color= "black", linetype="dashed") + 
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + 
  labs(title = "Shelters Occupancy Count by Organizations", x = "Occupancy Date",
       y = "Frequency", colour = "Shelter Names")
```

Unlike our initial thoughts, we have discovered that the number of occupancies in shelters have been generally decreasing or stable. However, there has been an interesting correlation between the decline in occupancies and the reported dates of active COVID-19 outbreaks in shelters. The dates of the active cases are indicated by the dashed black lines and as seen from the graph above, it is clear that some of these dates coincide with the sudden drop in occupancies. One possible explanation of this trend can be interpreted as a direct consequence of an outbreak occurring in the said shelter. For example, When there was an outbreak reported at St. Simon's Shelter on May 16th, the immediate drop in occupancies can be seen on the graph (as indicated by the second last line). However, a similar relationship, between occupancy counts and day of an outbreak, could be noticed even in locations that are not directly affected by the outbreak. Such correlation can be explained by many residents leaving the facilities in response to ongoing outbreaks in the surrounding shelters.  


```{r echo = FALSE}

# dataset used for model
shelterDataSub <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00") 

# removes all NaNs caused by zero capacity values 
shelterDataSub <- shelterDataSub[!(shelterDataSub$CAPACITY == 0), ] 

# model used for comparison with another model using Likelihood Test
shelterModel2 <- glm(OCCUPANCY ~ SECTOR + CAPACITY + SHELTER_CITY, data = shelterDataSub, family = poisson(link = "log"))

# manually assigning the baseline
shelterDataSub$SECTOR <- factor(shelterDataSub$SECTOR, ordered = FALSE)
shelterDataSub$SHELTER_CITY <- factor(shelterDataSub$SHELTER_CITY, ordered = FALSE)
shelterDataSub$category <- relevel(shelterDataSub$SECTOR, 'Men')
shelterDataSub$city <- relevel(shelterDataSub$SHELTER_CITY, 'Toronto')

# model of interest
shelterModel3 <- glm(OCCUPANCY ~ category + CAPACITY*city, data = shelterDataSub, family = poisson(link = "log"))
logRate2 <- cbind(est=shelterModel3$coef, confint(shelterModel3, level=0.95))
knitr::kable(cbind(summary(shelterModel3)$coeff, exp(logRate2)),digits=3)

# likelihood test
lmtest::lrtest(shelterModel2, shelterModel3)

```
The generalised linear model follows a Poisson regression with a log link, where the response represents the number of homeless clients in a shelter on that day.
The covariates in the model are: SECTOR (categorization of the type of residents from "Men", "Women", "Families", "Co-ed" and "Youth"), SHELTER_CITY (the city of the shelter locations from "Toronto", "North York", "Scarborough" and "Etobicoke"), and CAPCITY (the maximum number of beds available for the residents). 

The baseline represents the number of male homeless clients who are visiting a Toronto shelter. 

From the table above, we can see that there are more male clients in Toronto shelters than Women or Youth but less than families and co-ed clients in Toronto shelters. This is likely because these clients are considered at least pairs in numbers.

Furthermore, considering the capacity estimate is greater than 1, we can deduce that most shelters have not been filled to their full capacity. This coincides with the earlier graph showing a general decrease in occupancy as time progressed and such behavior may be attributed to the increasing cases of COVID-19 in shelters. Such trend is also prevalent when exploring the interactions between capacities and cities which implies that shelters in other cities also have vacant rooms/beds. 

Unsurprisingly, the table also illustrates that there are greater number of clients in Toronto areas than its surrounding cities. 

As seen from a small p-value, it is evident that model including the interaction between capacity and shelter city explains the data significantly more accurately. This is likely the result of some cities, such as Toronto, containing much larger facilities with higher capacity than other cities such as Scarborough and North York. 
