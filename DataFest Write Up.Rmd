---
title: "Explore the change of characteristics in shelters influenced by COVID-19, specifically sector composition as well as occupancy rate "
author: "Jonas Lee & Alex Kim"
date: "13/06/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
$\underline{OverView:}$
For our project we focused on exploring how COVID-19 influenced the change of characteristics within the GTA shelters. In particular we wanted to determine whether there was a change in the number of people using these shelters between March 17, 2020 and June 8, 2020, as well as not neglecting other important charactertics such as: gender compositions and the change in occupancy rate, pre and post March 17th..

$\underline{Summary of Statistics:}$
To help us analyze this issue we first gathered the daily data about the shelters listed in the GTA, that are publicly available here: â€œhttps://open.toronto.ca/dataset/daily-shelter-occupancy/". Initially, we expected the occupancy numbers to increase as a result of the lockdown enforcement, as well as the financial constraints that may have made payments to residency difficult. A scatterplot comparing occupancy to capacity over time was made, and it was observed that contrary to initial expectation there was a downward trend of of occupancy rate over time. This lead to an investiagtion resulting with number of occupants decreasing over time with some shelters have significant decreases. Further research revealed, that certain dates had significant drops, which matched the dates of signficant outbreaks of COVID-19 in some shelters.This can be seen in the plots of the four orgnaizations with vertical lines.

Concluding the research, several models were created, inclduing a logitsitical binominal GLM to analyze proportions of sectors (e.g. shelters exclsuively for men, etc), but ultimately a poisson regressional model to measure the count of the number of occupants per characteristic from March 17 2020 to June 8 2020, best fit the data. 

While we have concluded that this is the best fit model for the data, it is also important to note limitations such as: some shelters were over capacity, and that our variables were not independet, because our response variable was influenced by the results of previous days.

$\bold{01.01.2020}$ | $Co-ed$      | $Families$    | $Women$    | $Youth$ | $Capacity$ | $Etobicoke$   
--------     | -------      | ----------    | -------    | ------- | ---------- | -----------   
Estimate     |  0.73        |  1.48         | 0.66       |  0.70   |  1.00      |  0.30         
p-value      | < 0.001      | < 0.001       | < 0.001    | < 0.001 | < 0.001    |  < 0.001
$Output$     | $North York$ | $Scarborough$ | $Full Cap$ |$Cap:Eto$| $Cap:NY$   | $Cap:Scarb$  
Estimate     |  0.06        | 0.71          |   0.99     |  1.034  |  1.08      | 1.01          
p-value      | < 0.001      | < 0.001       |   0.12     | < 0.001 | < 0.001    | < 0.001        
$\bold{02.17.2020}$ | $Co-ed$      | $Families$    | $Women$    | $Youth$ | $Capacity$ | $Etobicoke$   
Estimate |  1.01        |  1.50         | 0.71       |  0.78   |  1.00      |  0.43         
p-value  | < 0.001      | 0.25          | < 0.001    | < 0.001 | < 0.001    |  < 0.001        
$Output$ | $North York$ | $Scarborough$ | $Full Cap$ |$Cap:Eto$| $Cap:NY$   | $Cap:Scarb$  
Estimate |  0.09        | 1.00          |   1.09     |  1.02   |  0.17      | 1.00             
p-value  | < 0.001      | 0.69          | < 0.001    | < 0.001 | < 0.001    | < 0.001        


```{r echo=FALSE, eval=TRUE, message=FALSE, results=FALSE}
#summary statistics that covers (mean, median, min, max, and the three quantiles)
#KEY COMPONENT UP THERE IS: message=FALSE
shelterData <- read.csv("https://raw.githubusercontent.com/alexminsung/ISSC/master/data/Daily%20shelter%20occpancy%20current.csv?token=APUVSRCQBS7QDHDGTMGCLMS65JGQU")
attach(shelterData)
library(shiny)
library(shinydashboard)
library(tidyverse)
library(ggplot2)
library(dplyr)
#summary(shelterData$OCCUPANCY)
shelterData_sub <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00")
summaryofdata <- summary(shelterData_sub$OCCUPANCY)
sdofdata <- sd(shelterData_sub$OCCUPANCY)
shelterData_men <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00" & as.character(SECTOR) == "Men")
#summaryofmen <- summary(shelterData_men$OCCUPANCY)
#summaryofmen
shelterData_wommen <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00" & as.character(SECTOR) == "Women")
#summaryofwomen <- summary(shelterData_wommen$OCCUPANCY)
#summaryofwomen
#sd(summaryofwomen$OCCUPANCY)
shelterData_coed <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00" & as.character(SECTOR) == "Co-ed")
shelterData_families <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00" & as.character(SECTOR) == "Families")
shelterData_youth <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00" & as.character(SECTOR) == "Youth")

#Proportion of People that stayed in shelters for Women:
womenshelter_proportion <- (sum(shelterData_wommen$OCCUPANCY) / sum(shelterData$OCCUPANCY))
womenshelter_proportion

#Proportion of People that  stayed in shelters for Men:
menshelter_proportion <- (sum(shelterData_men$OCCUPANCY) / sum(shelterData$OCCUPANCY))
menshelter_proportion

#Proportion of People that stayed in shelters for Youth:
youthnshelter_proportion <- (sum(shelterData_youth$OCCUPANCY) / sum(shelterData$OCCUPANCY))
youthnshelter_proportion

#Proportiong of People that stayed in Co-ed shelters:
coedshelter_proportion <- (sum(shelterData_coed$OCCUPANCY) / sum(shelterData$OCCUPANCY))
coedshelter_proportion

#Proportion of People that stayed in shelters for Families:
Familyshelter_proportion <- (sum(shelterData_families$OCCUPANCY) / sum(shelterData$OCCUPANCY))
Familyshelter_proportion
```

####$\underline{Summarizing Statistical Test Outcomes:}$
```{r echo=FALSE, message=FALSE, results=FALSE}
library(lmtest)
#install.packages("broom")
library(broom)
shelterDataSub <- shelterData %>%
  filter(as.character(OCCUPANCY_DATE) > "2020-03-17T00:00:00")
# removes all NaNs caused by zero capacity values 
shelterDataSub <- shelterDataSub[!(shelterDataSub$CAPACITY == 0), ] 

relaFreq = OCCUPANCY/CAPACITY

shelterModel2 <- glm(OCCUPANCY ~ SECTOR + CAPACITY + SHELTER_CITY, data = shelterDataSub, family = poisson(link = "log"))

logRate <- cbind(est=shelterModel2$coef, confint(shelterModel2, level=0.99))

shelterDataSub$SECTOR <- factor(shelterDataSub$SECTOR, ordered = FALSE)
shelterDataSub$SHELTER_CITY <- factor(shelterDataSub$SHELTER_CITY, ordered = FALSE)

shelterDataSub$category <- relevel(shelterDataSub$SECTOR, 'Men')
shelterDataSub$city <- relevel(shelterDataSub$SHELTER_CITY, 'Toronto')



shelterModel3 <- glm(OCCUPANCY ~ category + CAPACITY*city, data = shelterDataSub, family = poisson(link = "log"))
logRate2 <- cbind(est=shelterModel3$coef, confint(shelterModel3, level=0.95))
knitr::kable(cbind(exp(logRate2)),digits=3)
summary(shelterModel3)
#plot(shelterModel3)
#tidy(shelterModel3) #gives the coefficients of our model as a data frame
#glance(shelterModel3) #gives the rest of the stats as a data frame
#(tidy(shelterModel3)$p.value) #this just gives us the p-values
#hello <- data.frame((tidy(shelterModel3)$p.value))

lmtest::lrtest(shelterModel2, shelterModel3)
```

```{r echo=FALSE, results=FALSE}
table <- data.frame(cbind(exp(logRate2), summary(shelterModel3)$coeff[ ,4]))
names(table) <- c("est", "2.5%", "97.5%", "Pr(>|z|)")
knitr::kable(table,digits=3)
#plot(shelterModel3$y)
```


From the first table above which models pre-COVID-19 data (before March 17), we can see that majority of the clients in shelters are families, with males coming in second. This is likely because families come in at least pairs in numbers. 
The second table which models data during the pandemic (March 17 and onwards) shows relatively similar results with families still being the most predominant groups of clients and males coming in second once again. However, it is possible to observe that there are more women and youth occupants now then before. We believe this emphasis is a result of the overall number of occupants being almost halved during the pandemic (as seen from the graphs above).



From a summary of our model between the times of March 17th and June 8th, it can be observed that the covariates: Co-ed, women, men youth, capacity, full capacity etobicoke, North york, capacity of shelters in etobicoke, capacity of shelters in North York and capacity of shelters in Scarborough being statistically significant. In particular it can be seen that the covariate Families influnces the response variable the most. This could possibly be attributed to the range of reasons that a family has for staying in a shelter are more diverse than ranges for any of the other sectors.



From the gg-plot we noticed that there was a trend where shelters either approximately maintained a constant number of occupants in the shelters as time progressed, or had either a slight or significant decrease in the number of occupants in certain shelters or had certain dips in the number of reported occupants in shelters but was able to rally and proceed to approximately have a constant number of occupants. Particular we were able to identify drastic drops in the number of reported occupants in certain shelters, once a report on significant number of COVID-19 outbreaks occurred in other shelters in the GTA. Additionally notice that when the likelihood Ratio of Test Of Nested Models occurs, a p-value smaller than a 0.05 is obtained. This indicates the both our model is statistically significant, as well as allowing us to reject our null hypothesis. From the second slide it is possible to see that for the sector of women, there are bigger jumps between when the number of occupants were using shelter, in contrast to the men's slides where more of the shelters seem to have a more gradual decrease in the number of occupants.

Therefore we were able to determine our answer to our question and answer confidently that not only was there a change in occupancy in the GTA shelters, it in fact decreased, contrary to our intial thoughts!

